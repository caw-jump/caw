---
// BlockRenderer.astro - Renders blocks by type from page_blocks API data (DB-driven)
import CTA from './ui/CTA.astro';
import FunnelCalculator from './calculators/FunnelCalculator.jsx';
import ScalingSurvey from './interactivity/ScalingSurvey.tsx';

interface Block {
  id?: string;
  block_type: string;
  name?: string;
  data?: Record<string, unknown>;
}

interface Props {
  blocks: Block[];
}

type BentoItem = { title?: string; description?: string; href?: string };
type BulletItem = { icon?: string; title?: string; text?: string };

const { blocks } = Astro.props;
---
<style>
  .architect-section {
    background-color: #050505;
    color: #fff;
  }
  .text-architect {
    color: #00FF94;
  }
  .border-architect {
    border-color: rgba(0,255,148,0.3);
  }
  .bg-architect-dim {
    background-color: rgba(0,255,148,0.05);
  }
  .card-custom {
    background-color: #0F0F0F;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 1rem;
    padding: 2rem;
    transition: border-color 0.3s ease;
  }
  .card-custom:hover {
    border-color: rgba(0,255,148,0.5);
  }
  .font-mono {
    font-family: 'JetBrains Mono', monospace;
  }
</style>

{blocks.map((block) => {
  const d = block.data || {};
  switch (block.block_type) {
    case 'hero': {
      const badge = (d.badge as string) || '';
      const headline = (d.headline as string) || '';
      const subhead = (d.subhead as string) || '';
      const ctaLabel = (d.cta_label as string) || 'Book Consultation';
      const ctaHref = (d.cta_href as string) || '#contact';
      const warningText = (d.warning_text as string) || '';
      return (
        <section id="hook" class="min-h-screen flex items-center justify-center relative overflow-hidden pt-20 architect-section">
          <div class="bg-grid" />
          <div class="container mx-auto px-6 relative z-10 text-center">
            {badge && (
              <span class="inline-block font-mono text-sm uppercase tracking-[0.2em] mb-6 px-4 py-2 border border-[#00FF94]/50 bg-architect-dim text-neon">
                {badge}
              </span>
            )}
            <h1 class="text-5xl md:text-7xl font-black text-white mb-8 leading-tight" style="letter-spacing: -3px" set:html={headline} />
            {subhead && <p class="text-xl md:text-2xl text-white/70 max-w-3xl mx-auto mb-12 font-mono whitespace-pre-line">{subhead}</p>}
            <a href={ctaHref} class="btn-cyber">{ctaLabel}</a>
            {warningText && <p class="font-mono text-xs text-white/50 mt-8">{warningText}</p>}
          </div>
        </section>
      );
    }
    case 'terminal_problem': {
      const eyebrow = (d.eyebrow as string) || '';
      const title = (d.title as string) || '';
      const body = (d.body as string) || '';
      const bullets = (d.bullets as string[]) || [];
      const terminalLogs = (d.terminal_logs as { time?: string; msg?: string }[]) || [];
      const statusText = (d.status_text as string) || '';
      return (
        <section class="section-padding border-t border-white/10 bg-terminal">
          <div class="container mx-auto px-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-16 items-center">
              <div>
                {eyebrow && <span class="text-cyber-pink font-mono block mb-3">{eyebrow}</span>}
                <h2 class="text-3xl md:text-5xl font-bold text-white mb-4">{title}</h2>
                {body && <p class="text-lg text-white/70 mb-6">{body}</p>}
                <hr class="border-white/20 my-6" />
                {bullets.length > 0 && (
                  <ul class="list-none space-y-3 font-mono text-red-400">
                    {bullets.map((b) => <li>{b}</li>)}
                  </ul>
                )}
              </div>
              <div class="terminal-window">
                <div class="terminal-header">
                  <span class="terminal-dot terminal-dot-r" />
                  <span class="terminal-dot terminal-dot-y" />
                  <span class="terminal-dot terminal-dot-g" />
                  <span class="ml-2 text-white/50 text-sm">server_logs.txt</span>
                </div>
                <div class="font-mono text-sm">
                  {terminalLogs.map((log) => (
                    <div class="mb-2">
                      <span class="text-white/50">{log.time || ''}</span> {log.msg || ''}
                    </div>
                  ))}
                  {statusText && <div class="mt-3 text-neon">{statusText}</div>}
                </div>
              </div>
            </div>
          </div>
        </section>
      );
    }
    case 'solution_cards': {
      const eyebrow = (d.eyebrow as string) || '';
      const title = (d.title as string) || '';
      const cards = (d.cards as { title?: string; body?: string; border_color?: string }[]) || [];
      const borderColor = (c: { border_color?: string }) =>
        c.border_color === 'neon-green' ? 'var(--neon-green)' : c.border_color === 'neon-pink' ? 'var(--neon-pink)' : 'var(--neon-blue)';
      return (
        <section id="solution" class="section-padding bg-black relative">
          <div class="container mx-auto px-6">
            <div class="text-center mb-12">
              {eyebrow && <span class="text-cyber-blue font-mono block mb-2">{eyebrow}</span>}
              <h2 class="text-white text-2xl md:text-3xl font-bold">{title}</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              {cards.map((c) => (
                <div class="card-tech h-full cyber-border" style={`border-left-color: ${borderColor(c)}`}>
                  <h3 class="text-white text-lg font-bold mb-3" set:html={c.title || ''} />
                  <p class="text-white/70 text-sm">{c.body || ''}</p>
                </div>
              ))}
            </div>
          </div>
        </section>
      );
    }
    case 'authority': {
      const title = (d.title as string) || '';
      const body = (d.body as string) || '';
      const stats = (d.stats as { value?: string; label?: string }[]) || [];
      return (
        <section class="section-padding bg-terminal">
          <div class="container mx-auto px-6">
            <div class="max-w-3xl mx-auto text-center">
              <h2 class="text-white text-2xl md:text-4xl font-bold mb-6" set:html={title} />
              {body && <div class="text-white/70 mb-8 prose prose-invert max-w-none" set:html={body} />}
              {stats.length > 0 && (
                <div class="flex justify-center gap-12 font-mono text-neon border-t border-b border-white/10 py-6">
                  {stats.map((s) => (
                    <div>
                      <div class="text-2xl font-bold mb-0">{s.value || ''}</div>
                      <div class="text-sm text-white/60">{s.label || ''}</div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </section>
      );
    }
    case 'audit_form': {
      const title = (d.title as string) || 'Technical Strategy Session';
      const subhead = (d.subhead as string) || "Let's audit your stack and find the bottleneck.";
      const formTitle = (d.form_title as string) || 'INITIATE_HANDSHAKE_PROTOCOL';
      const submitSource = (d.submit_source as string) || 'ChrisAmayaWork';
      return (
        <section id="audit" class="section-padding relative overflow-hidden">
          <div class="absolute bottom-0 right-0 p-8 opacity-10 hidden md:block">
            <h1 class="text-6xl font-bold text-white">BUILD</h1>
          </div>
          <div class="container mx-auto px-6 relative z-10">
            <div class="max-w-xl mx-auto">
              <div class="bg-black border border-white/10 p-8 shadow-lg cyber-border">
                <div class="text-center mb-6">
                  <h3 class="text-white uppercase text-lg font-bold">{title}</h3>
                  <p class="text-white/60 text-sm font-mono mt-1">{subhead}</p>
                </div>
                <form id="architectForm" class="space-y-4">
                  <div>
                    <label class="text-neon font-mono text-xs uppercase block mb-1">Root User ID (Name)</label>
                    <input type="text" name="name" required placeholder="John Doe" class="w-full bg-[#1a1a1a] border border-white/20 text-white rounded-none font-mono px-4 py-2" />
                  </div>
                  <div>
                    <label class="text-neon font-mono text-xs uppercase block mb-1">Communication Link (Email)</label>
                    <input type="email" name="email" required placeholder="john@agency.com" class="w-full bg-[#1a1a1a] border border-white/20 text-white rounded-none font-mono px-4 py-2" />
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="text-neon font-mono text-xs uppercase block mb-1">Load (Revenue)</label>
                      <select name="revenue" class="w-full bg-[#1a1a1a] border border-white/20 text-white rounded-none font-mono px-4 py-2">
                        <option value="500k-1m">$500k - $1M</option>
                        <option value="1m-3m">$1M - $3M</option>
                        <option value="3m+">$3M+</option>
                      </select>
                    </div>
                    <div>
                      <label class="text-neon font-mono text-xs uppercase block mb-1">Budget</label>
                      <select name="budget" class="w-full bg-[#1a1a1a] border border-white/20 text-white rounded-none font-mono px-4 py-2">
                        <option value="10k+">$10k+</option>
                        <option value="25k+">$25k+</option>
                        <option value="50k+">$50k+</option>
                      </select>
                    </div>
                  </div>
                  <div>
                    <label class="text-neon font-mono text-xs uppercase block mb-1">System Error (The Problem)</label>
                    <textarea name="problem" rows={3} placeholder="What is currently breaking?" class="w-full bg-[#1a1a1a] border border-white/20 text-white rounded-none font-mono px-4 py-2" />
                  </div>
                  <button type="submit" class="btn-cyber w-full">{formTitle}</button>
                </form>
              </div>
            </div>
          </div>
          <script define:vars={{ submitSource }}>
            document.getElementById('architectForm')?.addEventListener('submit', async (e) => {
              e.preventDefault();
              const form = e.target;
              const btn = form.querySelector('button');
              const orig = btn.innerText;
              btn.innerText = 'ENCRYPTING_TRANSMISSION...';
              btn.disabled = true;
              const fd = new FormData(form);
              const data = Object.fromEntries(fd);
              data.source = submitSource;
              try {
                const r = await fetch(`${window.location.origin}/api/submit-lead`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (r.ok) { btn.innerText = 'TRANSMISSION_SUCCESSFUL'; btn.style.borderColor = 'var(--neon-green)'; setTimeout(() => { form.reset(); btn.innerText = orig; btn.disabled = false; }, 3000); }
                else throw new Error();
              } catch {
                btn.innerText = 'ERR_CONNECTION_REFUSED';
                btn.style.borderColor = 'var(--neon-pink)';
                setTimeout(() => { btn.innerText = orig; btn.disabled = false; }, 3000);
              }
            });
          </script>
        </section>
      );
    }
    case 'diagnosis': {
      const eyebrow = (d.eyebrow as string) || '';
      const title = (d.title as string) || '';
      const body = (d.body as string) || '';
      const warningBox = d.warning_box as { title?: string; text?: string } | undefined;
      const base = import.meta.env.BASE_URL || '/';
      const videoSrc = (d.video_src as string) || `${base}assets/videos/zombiebabyzaiper.mp4`;
      const videoPoster = (d.video_poster as string) || `${base}assets/videos/zombiebabyzaiper-poster.jpg`;
      const figLabel = (d.fig_label as string) || '';
      return (
        <section id="about" class="py-24 bg-[#08080A]">
          <div class="container mx-auto px-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
              <div>
                {eyebrow && <span class="font-mono text-xs uppercase font-bold text-architect tracking-[0.2em] mb-4 block">{eyebrow}</span>}
                <h2 class="text-4xl md:text-5xl font-bold text-white mb-6">{title}</h2>
                {body && <p class="text-lg text-white/70 mb-8">{body}</p>}
                {warningBox && (
                  <div class="bg-red-900/10 border border-red-500/20 rounded-lg p-6 mb-8">
                    <h4 class="text-red-500 font-bold mb-2">{warningBox.title || ''}</h4>
                    <p class="text-red-400/80 text-sm">{warningBox.text || ''}</p>
                  </div>
                )}
              </div>
              <div class="card-custom p-0 overflow-hidden border-architect/50 shadow-[0_0_30px_rgba(0,255,148,0.1)]">
                <div class="aspect-video bg-black rounded flex items-center justify-center relative">
                  <video autoplay loop muted playsinline class="w-full h-full object-cover" poster={videoPoster}>
                    <source src={videoSrc} type="video/mp4" />
                  </video>
                  {figLabel && (
                    <div class="absolute bottom-4 right-4 bg-black/80 backdrop-blur px-3 py-1 rounded border border-white/10">
                      <p class="font-mono text-[10px] text-[#00FF94] tracking-widest">{figLabel}</p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        </section>
      );
    }
    case 'calculator': {
      const sectionTitle = (d.section_title as string) || 'Engineering Resources';
      return (
        <section id="projects" class="py-24 architect-section">
          <div class="container mx-auto px-6">
            <h2 class="text-3xl font-bold text-center mb-12 text-white">{sectionTitle}</h2>
            <div class="max-w-4xl mx-auto glass-panel p-8 rounded-2xl border border-white/10">
              <FunnelCalculator client:visible />
            </div>
          </div>
        </section>
      );
    }
    case 'survey': {
      const sectionTitle = (d.section_title as string) || "Let's Build It Right.";
      return (
        <section id="contact" class="py-24 bg-black" aria-label="Contact form">
          <div class="container mx-auto px-6">
            <div class="max-w-3xl mx-auto">
              <h2 class="text-3xl font-bold text-center mb-12 text-white">{sectionTitle}</h2>
              <ScalingSurvey client:visible />
            </div>
          </div>
        </section>
      );
    }
    case 'cta': {
      const heading = (d.heading as string) || 'Ready to Scale Predictably?';
      const text = (d.text as string) || "Book a strategy call.";
      const href = (d.href as string) || '#contact';
      const label = (d.label as string) || 'Start Your Moat Audit';
      return (
        <section class="section light">
          <CTA heading={heading} text={text} href={href} label={label} />
        </section>
      );
    }
    case 'social_proof': {
      type Testimonial = { quote?: string; author?: string };
      const testimonials = (d.testimonials as Testimonial[]) || [];
      const logos = (d.logos as string[]) || [];
      const title = (d.title as string) || 'Trusted By';
      return (
        <section class="py-24 architect-section">
          <div class="container mx-auto px-6 max-w-4xl">
            {title && <h2 class="text-2xl font-bold text-center mb-12 text-white">{title}</h2>}
            {testimonials.length > 0 && (
              <div class="space-y-8 mb-12">
                {testimonials.map((t) => (
                  <blockquote class="border-l-4 border-architect pl-6 py-4">
                    <p class="text-lg text-white/80 italic">"{t.quote || ''}"</p>
                    {t.author && <cite class="text-sm text-white/50 mt-2 block">— {t.author}</cite>}
                  </blockquote>
                ))}
              </div>
            )}
            {logos.length > 0 && (
              <div class="flex flex-wrap gap-8 justify-center items-center opacity-70">
                {logos.map((logo) => (
                  <span class="text-white/60 text-sm font-mono">{logo}</span>
                ))}
              </div>
            )}
          </div>
        </section>
      );
    }
    case 'glass_card': {
      const variant = (d.variant as string) || 'default';
      const title = (d.title as string) || '';
      const body = (d.body as string) || '';
      return (
        <section class="py-16 architect-section">
          <div class="container mx-auto px-6">
            <div class="glass-card p-8 max-w-4xl mx-auto">
              {title && <h3 class="text-2xl font-bold text-white mb-4">{title}</h3>}
              {body && <div class="text-white/70 prose prose-invert" set:html={body} />}
            </div>
          </div>
        </section>
      );
    }
    case 'bento_grid': {
      const items = (d.items as BentoItem[]) || [];
      return (
        <section class="py-24 architect-section">
          <div class="container mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {items.map((item) => (
                item.href ? (
                  <a href={item.href} class="card-custom block p-6 border-architect/50 hover:border-architect transition">
                    <h4 class="text-lg font-bold text-white mb-2">{item.title || ''}</h4>
                    <p class="text-white/60 text-sm">{item.description || ''}</p>
                  </a>
                ) : (
                  <div class="card-custom p-6">
                    <h4 class="text-lg font-bold text-white mb-2">{item.title || ''}</h4>
                    <p class="text-white/60 text-sm">{item.description || ''}</p>
                  </div>
                )
              ))}
            </div>
          </div>
        </section>
      );
    }
    case 'value_prop': {
      const title = (d.title as string) || '';
      const body = (d.body as string) || '';
      const visualHtml = (d.visual_html as string) || '';
      return (
        <section class="py-24 bg-[#08080A]">
          <div class="container mx-auto px-6">
            <div class="grid md:grid-cols-2 gap-12 items-center">
              <div>
                {title && <h2 class="text-3xl font-bold text-white mb-6">{title}</h2>}
                {body && <div class="text-white/70 prose prose-invert" set:html={body} />}
              </div>
              {visualHtml && <div class="rounded-xl overflow-hidden" set:html={visualHtml} />}
            </div>
          </div>
        </section>
      );
    }
    case 'pull_quote': {
      const quote = (d.quote as string) || '';
      const author = (d.author as string) || '';
      return (
        <section class="py-16 architect-section">
          <div class="container mx-auto px-6 max-w-3xl">
            <blockquote class="text-2xl md:text-3xl font-bold text-white/90 text-center">
              "{quote}"
            </blockquote>
            {author && <cite class="block text-center text-white/50 mt-4">— {author}</cite>}
          </div>
        </section>
      );
    }
    case 'icon_bullets': {
      const title = (d.title as string) || '';
      const bullets = (d.bullets as BulletItem[]) || [];
      return (
        <section class="py-24 architect-section">
          <div class="container mx-auto px-6">
            {title && <h2 class="text-2xl font-bold text-center mb-12 text-white">{title}</h2>}
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
              {bullets.map((b) => (
                <div class="card-custom p-6">
                  {b.icon && <span class="text-3xl mb-4 block">{b.icon}</span>}
                  <h4 class="text-lg font-bold text-white mb-2">{b.title || ''}</h4>
                  <p class="text-white/60 text-sm">{b.text || ''}</p>
                </div>
              ))}
            </div>
          </div>
        </section>
      );
    }
    case 'related_services': {
      const services = (d.services as BentoItem[]) || [];
      return (
        <section class="py-24 bg-[#08080A]">
          <div class="container mx-auto px-6">
            <div class="grid md:grid-cols-3 gap-8">
              {services.map((s) => (
                s.href ? (
                  <a href={s.href} class="card-custom block p-6 border-white/10 hover:border-architect transition">
                    <h4 class="text-lg font-bold text-white mb-2">{s.title || ''}</h4>
                    <p class="text-white/60 text-sm">{s.description || ''}</p>
                  </a>
                ) : (
                  <div class="card-custom p-6">
                    <h4 class="text-lg font-bold text-white mb-2">{s.title || ''}</h4>
                    <p class="text-white/60 text-sm">{s.description || ''}</p>
                  </div>
                )
              ))}
            </div>
          </div>
        </section>
      );
    }
    case 'animated_section': {
      const title = (d.title as string) || '';
      const body = (d.body as string) || '';
      return (
        <section class="py-24 architect-section animate-on-scroll">
          <div class="container mx-auto px-6">
            {title && <h2 class="text-2xl font-bold text-white mb-6">{title}</h2>}
            {body && <div class="text-white/70 prose prose-invert" set:html={body} />}
          </div>
        </section>
      );
    }
    default:
      return null;
  }
})}
